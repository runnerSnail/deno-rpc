import { str2ab, getPlatformEndianness,LITTLE_ENDIAN ,str2Uint8Array,ab2str} from "../lib/util.ts";
import { test,runTests,assertEquals } from "../deps.ts";
const { Buffer } = Deno;

const payload = {
    service: 'com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.acom.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.acom.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.acom.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.acom.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.acom.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.acom.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.acom.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.acom.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.acom.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.acom.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.acom.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.acom.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.acom.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.acom.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0com.alipay.nodejs.HelloService:1.0',
    methodName: 'plus',
    args: [1, 2],
};


// encode

const payloadLength = str2ab(JSON.stringify(payload)).byteLength;

const request = new ArrayBuffer(10 + payloadLength);

const dvReq = new DataView(request);
dvReq.setInt8(0,1);
dvReq.setInt32(1,1000);
dvReq.setInt8(5,1);
dvReq.setInt32(6,payloadLength);


let index = 10; 
let date1 = new Date().getTime();
for (const item of str2Uint8Array(JSON.stringify(payload))) {
    dvReq.setUint8(index++,item);
}
console.log(new Date().getTime() - date1);
const v2 = new Uint8Array(dvReq.buffer, 10);
// console.log(ab2str(v2));
test({
    name: "BIG_ENDIAN or LITTLE_ENDIAN",
    fn(): void {
        // console.log(getPlatformEndianness())
        assertEquals(getPlatformEndianness(), LITTLE_ENDIAN);
    }
});



runTests();